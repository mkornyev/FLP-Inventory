{% extends "inventory/base.html" %}

{% block page_specific_scripts %}
  {% if tx == 'Checkout' and itemizedOutput %}
  {% load static %}
    <script src="{% static 'inventory/price_adjust_scripts.js' %}"></script>
  {% endif %}
{% endblock %}

{% block content %}
<form class="check-report-form" method="POST" action="{% url 'Report' %}">
<div class="container">
    <script type="text/javascript">

    // The Browser API key obtained from the Google API Console.
    // Replace with your own Browser API key, or your own key.
    var developerKey = 'AIzaSyBWBb881bGEQvfRRWm6tUXOJexU1j5jd4M';

    // The Client ID obtained from the Google API Console. Replace with your own Client ID.
    var clientId = "903076341382-g888j3cbjnaqqa1pmbpkgc5cjih5dv9l.apps.googleusercontent.com"

    // Replace with your own project number from console.developers.google.com.
    // See "Project number" under "IAM & Admin" > "Settings"
    var appId = "903076341382";

    // Scope to use to access user's Drive items.
    var scope = ['https://www.googleapis.com/auth/drive.file'];

    var pickerApiLoaded = false;
    var oauthToken;

    // Use the Google API Loader script to load the google.picker script.
    function loadPicker() {
      gapi.load('auth', {'callback': onAuthApiLoad});
      gapi.load('picker', {'callback': onPickerApiLoad});
    }

    function onAuthApiLoad() {
      window.gapi.auth.authorize(
          {
            'client_id': clientId,
            'scope': scope,
            'immediate': false
          },
          handleAuthResult);
    }

    function onPickerApiLoad() {
      pickerApiLoaded = true;
      createPicker();
    }

    function handleAuthResult(authResult) {
      if (authResult && !authResult.error) {
        oauthToken = authResult.access_token;
        createPicker();
      }
    }

    // Create and render a Picker object for searching images.
    function createPicker() {
      if (pickerApiLoaded && oauthToken) {
        var uploadView = new google.picker.DocsUploadView();
        var picker = new google.picker.PickerBuilder()
            .setAppId(appId)
            .setOAuthToken(oauthToken)
            .addView(uploadView)
            .setDeveloperKey(developerKey)
            .setCallback(pickerCallback)
            .build();
         picker.setVisible(true);
      }
    }

    // A simple callback implementation.
    function pickerCallback(data) {
      if (data.action == google.picker.Action.PICKED) {
        var fileName = data.docs[0].name;
        alert('Successfully uploaded ' + fileName  + ' to Google Drive!');
      }
    }
    </script>
    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>


    <div class="row">
        <div class="col">

          {% include 'inventory/reports/_controls.html' %}

          {% csrf_token %}
          <hr>

        </div>
    </div>

    <div class="row mt-5">
      <div class="col">
        {% if results %}

          <h4>Filtered {{ tx }}s | <span id="report_total" class="monetary-value">${{ totalValue }}</span>:</h4>
          {% if tx == 'Checkout' and itemizedOutput %}
          <p>To make a price adjustment: click the <span class="bold">Price</span> field, update it, and Export.
            <br>Temporary adjustments appear in <span class="bold blue">blue</span>.
            <br>Once you refresh the page your changes will be lost.
          </p>
          {% endif %}

          {% if itemizedOutput %}
            {% include 'inventory/reports/_item_table.html' %}
          {% else %}
            {% include 'inventory/reports/_tx_table.html' %}
          {% endif %}

          <!-- Pagination -->
          {% if results.has_other_pages %}

            {% include 'inventory/_pagination.html' %}
          
          {% endif %}

          {% if itemizedOutput %}
            <span style="color: red">*</span> Price is zero
          {% else %}
            <span style="color: red">*</span> Price is missing
          {% endif %}

        {% else %}
          <p>No results for the specified filters.</p>
        {% endif %}

        {% if itemizedOutput and tx == "Checkout" %}
          <div class="row">
            <div class="col mt-2"><br>
              <button class="btn btn-lg btn-warning {% if tx == 'Checkin' or not results %}disabled{% endif %}"  name="export" type="submit">Export (By Item)</button>
              <button id="google-btn" class="btn btn-lg btn-warning {% if tx == 'Checkin' or not results %}disabled{% endif %}" onclick="loadPicker()" type="button">Upload to Google Drive</button>
            </div>
          </div>
        {% else %}
          <div class="row">
            <div class="col mt-2"><br>
              <button class="btn btn-lg btn-warning {% if not results %}disabled{% endif %}" name="export_table" type="submit">Export {% if tx %}(By {{tx}}){% endif %}</button>
              <button id="google-btn" class="btn btn-lg btn-warning {% if not results %}disabled{% endif %}" onclick="loadPicker()" type="button">Upload to Google Drive</button>
            </div>
          </div>
          <br>
        {% endif %}
        <br>

      </div>
    </div>
</div>
</form>

{% endblock %}